---
- name: Install neovim dependencies (Debian)
  when: ansible_os_family == "Debian"
  apt: name="{{ packages }}" state=latest
  become: yes
  vars:
    packages:
    - ninja-build
    - gettext
    - libtool
    - libtool-bin
    - autoconf
    - automake
    - cmake
    - g++
    - pkg-config
    - unzip

- name: Install neovim dependencies (OS X)
  when: ansible_os_family == "Darwin"
  homebrew: name="{{ packages }}" state=latest
  vars:
    packages:
      - ninja
      - gettext
      - libtool
      - autoconf
      - automake
      - cmake
      - pkg-config
      - unzip

- name: Create neovim dir
  file:
    state: directory
    path: "{{ nonwork_code_dir }}/neovim"

- name: Delete pesky nightly tag from neovim repository (sheesh)
  command: git tag -d nightly
  args:
    chdir: "{{ nonwork_code_dir }}/neovim"
  ignore_errors: yes

- name: Clone or Update neovim repository
  git:
    repo: 'git@github.com:neovim/neovim.git'
    dest: "{{ nonwork_code_dir }}/neovim"
    version: "{{ neovim_version }}"
  register: neovim_git_result

- stat:
    path: "{{ user_bin_dir }}/nvim"
  register: neovim_bin

- name: (Re)build neovim
  include: build_neovim.yml
  when: (neovim_git_result.after != neovim_git_result.before) or
        (not neovim_bin.stat.exists)

# We also do this as a step in build_neovim.yml, but there are times where we
# don't want to build neovim and yet still want this step.
- name: Save neovim config
  template:
    src: init.vim.j2
    dest: "{{ ansible_env.HOME }}/.config/nvim/init.vim"
    mode: "u=rw,g=,o="

- name: Install/Update neovim plugins
  command: "{{ user_bin_dir}}/nvim -c PlugUpdate -c quitall"
# Note to self: I tried to add a 'changed_when' here, and the closest I got to
# was that you can inspect the output of the PlugDiff command to see what was changed.
# I decided to give up before I figured out how to parse that out properly from the
# curses-style output.
